---
title: "Summer 2025 Preliminary Data"
author: "Nidhi Ram"
date: "2025-05-28"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(sf) 
library(ggplot2) 
library(leaflet) 
library(dplyr) 
library(tigris) 
library(tidyr)
library(gt)
library(zipcodeR)
library(maps)
library(tidycensus)
library(terra)
library(exactextractr)
library(raster)
library(tidycensus)
library(ggthemes)
library(units)

```

```{r, userdirectory, echo = TRUE, message=FALSE, warning=FALSE}

# Set user directory and folder
user <- "/Users/nidhiram"
directory <- "/Downloads"
folder <- "/Summer 2025 Project" 

# Set working directory (make sure all shapefile files are located in the working directory)
working_directory <- "/Users/nidhiram/Downloads/Summer 2025 Project"
print(working_directory)
setwd(working_directory)

```

Census of Agricultural Data: AgCensus https://www.nass.usda.gov/Publications/AgCensus/2022/Online_Resources/Ag_Census_Web_Maps/Data_download/index.php
```{r}
path <- "~/Downloads/Summer 2025 Project/NASSAgCensusDownload2022_175maps_Links.xlsx"
sheet_names <- excel_sheets(path)
data_farms <- read_excel("~/Downloads/Summer 2025 Project/NASSAgCensusDownload2022_175maps_Links.xlsx", sheet = "Farms")
data_livestock <- read_excel(path, sheet = "Livestock and Animals")
data_codebook <- read_excel(path, sheet = "Variable Lookup")
data_economics <- read_excel(path, sheet= "Economics")
```

# Farm Data from AGCensus
```{r}
data_farms <- subset(data_farms, select = -c(FIPSTEXT,
                                             y22_M001_valueText, y22_M002_valueText, y22_M050_valueText, y22_M051_valueText, y22_M054_valueText, y22_M053_valueText,y22_M055_valueText, y22_M056_valueText, y22_M057_valueText, y22_M058_valueText, y22_M059_valueText, y22_M064_valueText, y22_M065_valueText, y22_M066_valueText, y22_M067_valueText, y22_M068_valueText, y22_M069_valueText, y22_M070_valueText, y22_M071_valueText, y22_M080_valueText, y22_M174_valueText, y22_M081_valueText, y22_M079_valueText, y22_M052_valueText))
# y22_M001_classRange, y22_M002_classRange, y22_M050_classRange, y22_M051_classRange,
# y22_M054_classRange, y22_M053_classRange,y22_M055_classRange, y22_M056_classRange,
# y22_M057_classRange, y22_M058_classRange, y22_M059_classRange, y22_M064_classRange,
# y22_M065_classRange, y22_M066_classRange, y22_M067_classRange, y22_M068_classRange, 
# y22_M069_classRange, y22_M070_classRange, y22_M071_classRange, y22_M080_classRange,
# y22_M174_classRange, y22_M081_classRange, y22_M079_classRange, y22_M052_classRange))

names(data_farms)[names(data_farms) == "y22_M001_valueNumeric"] <- "Number of Farms" ## GOOD TO KNOW
names(data_farms)[names(data_farms) == "y22_M002_valueNumeric"] <- "Avg Size of Farms (Acres)"
names(data_farms)[names(data_farms) == "y22_M050_valueNumeric"] <- "Acres Farmland as % of Land Area" ### THIS IS AN IMPORTANT ONE!!
names(data_farms)[names(data_farms) == "y22_M051_valueNumeric"] <- "Acres Irrigated Land as % of Land Area"
names(data_farms)[names(data_farms) == "y22_M052_valueNumeric"] <- "Acres Cropland as % of Land Area" ### THIS COULD BE IMPORTANT
names(data_farms)[names(data_farms) == "y22_M053_valueNumeric"] <- "Acres Cropland as % of Farmland" ### THIS COULD BE IMPORTANT
names(data_farms)[names(data_farms) == "y22_M054_valueNumeric"] <- "Acres Harvested Cropland as % of Farmland"
names(data_farms)[names(data_farms) == "y22_M055_valueNumeric"] <- "Acres Irrigated Harvested Cropland as % of All Harvested Cropland"
names(data_farms)[names(data_farms) == "y22_M056_valueNumeric"] <- "Acres Pastureland as % of Farmland"
names(data_farms)[names(data_farms) == "y22_M057_valueNumeric"] <- "Acres with Irrigation Systems as % of Farmland"
names(data_farms)[names(data_farms) == "y22_M058_valueNumeric"] <- "Acres Enrolled in Conservation Reserve, Wetlands Reserve, Farmable Wetlands, or Conservation Reserve Enhancement Programs as % of Farmland"
names(data_farms)[names(data_farms) == "y22_M059_valueNumeric"] <- "Acres Enrolled in Crop Insurance Programs as % of Farmland"

names(data_farms)[names(data_farms) == "y22_M064_valueNumeric"] <- "Acres Treated with Commercial Fertilizer, Lime, and Soil Conditioners as % of Total Cropland"
names(data_farms)[names(data_farms) == "y22_M065_valueNumeric"] <- "Acres Cropland Fertilized as % of All Cropland (Excluding Pastured)"
names(data_farms)[names(data_farms) == "y22_M066_valueNumeric"] <- "Acres Cropland and Pastureland Treated with Animal Manure as % of Total Cropland"
names(data_farms)[names(data_farms) == "y22_M067_valueNumeric"] <- "Acres Treated with Chemicals for Insects as % of Total Cropland"
names(data_farms)[names(data_farms) == "y22_M068_valueNumeric"] <- "Acres Treated with Chemicals for Nematodes as % of Total Cropland"
names(data_farms)[names(data_farms) == "y22_M069_valueNumeric"] <- "Acres Treated with Chemicals for Weeds, Grass, or Brush as % of Total Cropland"
names(data_farms)[names(data_farms) == "y22_M070_valueNumeric"] <- "Acres Treated with Chemicals for Growth, Thin Fruit, Ripen, or Defoliate as % of Total Cropland"
names(data_farms)[names(data_farms) == "y22_M071_valueNumeric"] <- "Acres Treated with Chemicals for Disease in Crops and Orchards as % of Total Cropland"

names(data_farms)[names(data_farms) == "y22_M079_valueNumeric"] <- "% of Farms Operated by Family/Individual"
names(data_farms)[names(data_farms) == "y22_M080_valueNumeric"] <- "% of Farms Operated by Partnership "
names(data_farms)[names(data_farms) == "y22_M081_valueNumeric"] <- "% of Farms Operated by Coroporation"
names(data_farms)[names(data_farms) == "y22_M174_valueNumeric"] <- "% of Farms with Internet Access"

sum(is.na(data_farms)) # 4073
```

## Map of Number of Farms in US by County
```{r}
census_farm_count <- as.data.frame(list(FIPS = data_farms$FIPS, Number_of_Farms = data_farms$`Number of Farms`), row.names=NULL, optional = FALSE)
census_farm_count$FIPS <- str_pad(census_farm_count$FIPS, width = 5, side = "left", pad = "0")

```

```{r, fig.align="center", echo = FALSE, fig.width = 14}
us_counties <- counties(cb = TRUE, resolution = "20m", refresh=TRUE)
# List of FIPS codes for contiguous US states
contiguous_states <- c(
  "01", "04", "05", "06", "08", "09", "10", "11", "12", "13", "16", "17", 
  "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", 
  "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "44", 
  "45", "46", "47", "48", "49", "50", "51", "53", "54", "55", "56")

# Filter US counties to include only those in contiguous states
us_counties_contiguous <- us_counties %>%
  filter(STATEFP %in% contiguous_states)

us_counties_contiguous <- us_counties_contiguous %>%
  mutate(FIPS = paste0(STATEFP, COUNTYFP))  # create matching FIPS code

us_counties <- us_counties %>%
  mutate(FIPS = paste0(STATEFP, COUNTYFP))  # create matching FIPS code

counties_census_farm_count <- left_join(us_counties_contiguous, census_farm_count, by = "FIPS")

ggplot(data = counties_census_farm_count) +
  geom_sf(aes(fill = Number_of_Farms), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(
    fill = "Number of Farms",
    title = "Number of Farms by County"
  ) +
  theme_minimal()
```


## Map of Farm Percentage in US by County
```{r}
census_farm_proportion <- as.data.frame(list(FIPS = data_farms$FIPS, farm_percentage = data_farms$`Acres Farmland as % of Land Area`), row.names=NULL, optional = FALSE)
census_farm_proportion$FIPS <- str_pad(census_farm_proportion$FIPS, width = 5, side = "left", pad = "0")

```

```{r}
counties_census_farm_prop <- left_join(us_counties_contiguous, census_farm_proportion, by = "FIPS")

ggplot(data = counties_census_farm_prop) +
  geom_sf(aes(fill = farm_percentage), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(
    fill = "Acres Farmland as % of Land Area",
    title = "Acres Farmland as % of Land Area by County"
  ) +
  theme_minimal()
```

## Irrigated Land
```{r}
census_irrigated_land <- as.data.frame(list(FIPS = data_farms$FIPS, irrigated_land = data_farms$`Acres Irrigated Harvested Cropland as % of All Harvested Cropland`), row.names=NULL, optional = FALSE)
census_irrigated_land$FIPS <- str_pad(census_irrigated_land$FIPS, width = 5, side = "left", pad = "0")

```

# Livestock and Animal Data from AgCensus 
```{r}
names(data_livestock)
data_livestock <- subset(data_livestock, select = -c(FIPS, y22_M098_valueText, y22_M099_valueText, y22_M100_valueText, y22_M101_valueText, y22_M102_valueText, y22_M103_valueText, y22_M104_valueText, y22_M105_valueText))

names(data_livestock)[names(data_livestock) == "FIPSTEXT"] <- "FIPS"
names(data_livestock)[names(data_livestock) == "y22_M098_valueNumeric"] <- "Average # of Cattle and Calves per 100 Acres of All Farmland"
names(data_livestock)[names(data_livestock) == "y22_M099_valueNumeric"] <- "Cow and Heifers That Had Calved"
names(data_livestock)[names(data_livestock) == "y22_M100_valueNumeric"] <- "Cows and Heifers that Had Calved as % of Cattle/Calves"
names(data_livestock)[names(data_livestock) == "y22_M101_valueNumeric"] <- "# of Cattle and Calves Sold" ### IMPORTANT
names(data_livestock)[names(data_livestock) == "y22_M102_valueNumeric"] <- "All Goats"
names(data_livestock)[names(data_livestock) == "y22_M103_valueNumeric"] <- "Milk Goats"
names(data_livestock)[names(data_livestock) == "y22_M104_valueNumeric"] <- "Meat and Other Goats"
names(data_livestock)[names(data_livestock) == "y22_M105_valueNumeric"] <- "Horses and Ponies"

## create a column adding all animals
data_livestock$total_livestock <- data_livestock$`# of Cattle and Calves Sold` + data_livestock$`All Goats` + data_livestock$`Horses and Ponies`


```

## Map of Cattle/Calves Proportion in US by County
```{r}
census_cattle_prop <- as.data.frame(list(FIPS = data_livestock$FIPS, cattle_proportion = data_livestock$`Average # of Cattle and Calves per 100 Acres of All Farmland`), row.names=NULL, optional = FALSE)
census_cattle_prop$FIPS <- str_pad(census_cattle_prop$FIPS, width = 5, side = "left", pad = "0")

```

```{r}
counties_census_cattle_prop <- left_join(us_counties_contiguous, census_cattle_prop, by = "FIPS")

ggplot(data = counties_census_cattle_prop) +
  geom_sf(aes(fill = cattle_proportion), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(
    fill = "'' ''",
    title = "Average # of Cattle and Calves per 100 Acres of all Land in Farm by County"
  ) +
  theme_minimal()
```

## Map of Goats in US by County
```{r}
census_goat_count <- as.data.frame(list(FIPS = data_livestock$FIPS, num_goats = data_livestock$`All Goats`), row.names=NULL, optional = FALSE)
census_goat_count$FIPS <- str_pad(census_goat_count$FIPS, width = 5, side = "left", pad = "0")

```

```{r}
counties_census_goat_count <- left_join(us_counties_contiguous, census_goat_count, by = "FIPS")

ggplot(data = counties_census_goat_count) +
  geom_sf(aes(fill = num_goats), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(
    fill = "Number of Goats",
    title = "Number of Goats (Inventory) by County"
  ) +
  theme_minimal()
```

# Economic Data (e.g. Sales)
```{r}
names(data_economics)
data_economics <- subset(data_economics, select = -c(FIPS, y22_M003_valueText, y22_M004_valueText, y22_M005_valueText, y22_M006_valueText, y22_M007_valueText, y22_M008_valueText, y22_M009_valueText, y22_M010_valueText, y22_M011_valueText, y22_M012_valueText, y22_M013_valueText, y22_M014_valueText, y22_M015_valueText, y22_M016_valueText, y22_M017_valueText, y22_M018_valueText, y22_M019_valueText, y22_M020_valueText, y22_M021_valueText, y22_M022_valueText, y22_M023_valueText, y22_M024_valueText, y22_M025_valueText, y22_M026_valueText, y22_M027_valueText, y22_M028_valueText, y22_M029_valueText, y22_M030_valueText, y22_M031_valueText, y22_M032_valueText, y22_M033_valueText, y22_M034_valueText, y22_M035_valueText, y22_M036_valueText, y22_M037_valueText, y22_M038_valueText, y22_M039_valueText, y22_M040_valueText, y22_M041_valueText, y22_M042_valueText, y22_M043_valueText, y22_M044_valueText, y22_M045_valueText, y22_M046_valueText, y22_M047_valueText, y22_M060_valueText, y22_M061_valueText, y22_M062_valueText, y22_M063_valueText, y22_M175_valueText))

names(data_economics)[names(data_economics) == "FIPSTEXT"] <- "FIPS"

names(data_economics)[names(data_economics) == "y22_M003_valueNumeric"] <- "% of Farms with Sales of Less Than $10,000"
names(data_economics)[names(data_economics) == "y22_M004_valueNumeric"] <- "% of Farms with Sales of $10,000 to $249,999"
names(data_economics)[names(data_economics) == "y22_M005_valueNumeric"] <- "% of Farms with Sales of $250,000 or More"
names(data_economics)[names(data_economics) == "y22_M006_valueNumeric"] <- "Avg Value of Ag Products Sold per Farm" ## THIS IS IMPORTANT
names(data_economics)[names(data_economics) == "y22_M007_valueNumeric"] <- "Value of Crops Sold as % of Total Market Value of Ag Products Sold"
names(data_economics)[names(data_economics) == "y22_M008_valueNumeric"] <- "Avg Value of Crops Solds per Acre Harvested Cropland"
names(data_economics)[names(data_economics) == "y22_M009_valueNumeric"] <- "Value of Grains, Oilseeds, Dry Beans, and Dry Peas Sold as % of Total Market Value of Ag Products Sold"

names(data_economics)[names(data_economics) == "y22_M010_valueNumeric"] <- "Value of Cotton and Cottonseed Sold as % of Total Market Value of Ag Products Sold"
names(data_economics)[names(data_economics) == "y22_M011_valueNumeric"] <- "Value of Tobacco Sold as % of Total Market Value of Ag Products Sold"
names(data_economics)[names(data_economics) == "y22_M012_valueNumeric"] <- "Value of Other Crops and Hay Sold as % of Total Market Value of Ag Products Sold"
names(data_economics)[names(data_economics) == "y22_M013_valueNumeric"] <- "Value of Vegetables, Melons, Potatoes, and Sweet Potatoes Sold as % of Total Market Value of Ag Products Sold"
names(data_economics)[names(data_economics) == "y22_M014_valueNumeric"] <- "Value of Fruits, Tree Nuts, and Berries Sold as % of Total Market Value of Ag Products Sold"
names(data_economics)[names(data_economics) == "y22_M015_valueNumeric"] <- "Value of Nursery, Greenhouse, Floriculture, and Sod Sold as Percent of Total Market Value of Agricultural Products Sold"
names(data_economics)[names(data_economics) == "y22_M016_valueNumeric"] <- "Value of Cultivated Christmas Trees and Short Rotation Woody Crops Sold as Percent of Total Market Value of Agricultural Products Sold"
names(data_economics)[names(data_economics) == "y22_M017_valueNumeric"] <- "Value of Livestock, Poultry, and Their Products Sold as Percent of Total Market Value of Agricultural Products Sold"
names(data_economics)[names(data_economics) == "y22_M018_valueNumeric"] <- "Value of Poultry and Eggs Sold as Percent of Total Market Value of Agricultural Products Sold"
names(data_economics)[names(data_economics) == "y22_M019_valueNumeric"] <- "Value of Milk from Cows, Sold as Percent of Total Market Value of Agricultural Products Sold"

names(data_economics)[names(data_economics) == "y22_M020_valueNumeric"] <- "Value of Cattle and Calves Sold as Percent of Total Market Value of Agricultural Products Sold"
names(data_economics)[names(data_economics) == "y22_M021_valueNumeric"] <- "Value of Hogs and Pigs Sold as Percent of Total Market Value of Agricultural Products Sold"
names(data_economics)[names(data_economics) == "y22_M022_valueNumeric"] <- "Value of Sheep, Goats, Wool, Mohair, and Milk Sold as Percent of Total Market Value of Agricultural Products Sold"
names(data_economics)[names(data_economics) == "y22_M023_valueNumeric"] <- "Net Cash Farm Income of Operations"
names(data_economics)[names(data_economics) == "y22_M024_valueNumeric"] <- "Net Cash Farm Income of Operation, Average per Farm"
names(data_economics)[names(data_economics) == "y22_M025_valueNumeric"] <- "Net Cash Farm Income of Producers"
names(data_economics)[names(data_economics) == "y22_M026_valueNumeric"] <- "Net Cash Farm Income of Producers, Average per Farm"
names(data_economics)[names(data_economics) == "y22_M027_valueNumeric"] <- "Average Value per Farm of Agricultural Products Sold Directly to Consumers"
names(data_economics)[names(data_economics) == "y22_M028_valueNumeric"] <- "Total Received from Government Payments, Average Per Farm"
names(data_economics)[names(data_economics) == "y22_M029_valueNumeric"] <- "% of Farms Receiving Government Payments"

names(data_economics)[names(data_economics) == "y22_M030_valueNumeric"] <- "Payments Received from Conservation Reserve, Wetlands Reserve, Farmable Wetlands and Conservation Reserve Enhancement Programs, Average per Farm"
names(data_economics)[names(data_economics) == "y22_M031_valueNumeric"] <- "Payments Received from Other Federal Farm Programs, Average per Farm"
names(data_economics)[names(data_economics) == "y22_M032_valueNumeric"] <- "Total Amount Received from Government Commodity Credit Corporation Loans, Average per Farm"
names(data_economics)[names(data_economics) == "y22_M033_valueNumeric"] <- "Total Income from Farm-Related Sources, Average per Farm"
names(data_economics)[names(data_economics) == "y22_M034_valueNumeric"] <- "Average Total Farm Production Expenses per Farm"
names(data_economics)[names(data_economics) == "y22_M035_valueNumeric"] <- "Expenses for Livestock and Poultry Purchased or Leased as % of Total Farm Production Expenses"
names(data_economics)[names(data_economics) == "y22_M036_valueNumeric"] <- "Expenses for Feed Purchased as % of Total Farm Production Expenses"
names(data_economics)[names(data_economics) == "y22_M037_valueNumeric"] <- "Expenses for Seeds, Plants, Vines, and Trees Purchased as Percent of Total Farm Production Expenses"
names(data_economics)[names(data_economics) == "y22_M038_valueNumeric"] <- "Expenses for Fertilizer, Lime, and Soil Conditioners Purchased as Percent of Total Farm Production Expenses"
names(data_economics)[names(data_economics) == "y22_M039_valueNumeric"] <- "Expenses for Chemicals Purchased as Percent of Total Farm Production Expenses"

names(data_economics)[names(data_economics) == "y22_M040_valueNumeric"] <- "Expenses for Gasoline, Fuels, and Oils Purchased as Percent of Total Farm Production Expenses"
names(data_economics)[names(data_economics) == "y22_M041_valueNumeric"] <- "Expenses for Utilities as Percent of Total Farm Production Expenses"
names(data_economics)[names(data_economics) == "y22_M042_valueNumeric"] <- "Expenses for Total Labor as Percent of Total Farm Production Expenses"
names(data_economics)[names(data_economics) == "y22_M043_valueNumeric"] <- "Expenses for Hired Farm Labor as Percent of Total Farm Production Expenses"
names(data_economics)[names(data_economics) == "y22_M044_valueNumeric"] <- "Expenses for Contract Labor as Percent of Total Farm Production Expenses"
names(data_economics)[names(data_economics) == "y22_M045_valueNumeric"] <- "Expenses for Customwork and Custom Hauling as Percent of Total Farm Production Expenses"
names(data_economics)[names(data_economics) == "y22_M046_valueNumeric"] <- "Expenses for Interest Paid on Debts as Percent of Total Farm Production Expenses"
names(data_economics)[names(data_economics) == "y22_M047_valueNumeric"] <- "Expenses for Repairs, Supplies, and Maintenance as Percent of Total Farm Production Expenses"

names(data_economics)[names(data_economics) == "y22_M060_valueNumeric"] <- "Estimated Market Value of Land and Buildings, Average per Farm"
names(data_economics)[names(data_economics) == "y22_M061_valueNumeric"] <- "Estimated Market Value of All Machinery and Equipment on Operation, Average per Farm"
names(data_economics)[names(data_economics) == "y22_M062_valueNumeric"] <- "Average Number of Harvested Cropland Acres per Tractor"
names(data_economics)[names(data_economics) == "y22_M063_valueNumeric"] <- "Average Number of Corn, Soybean, and Wheat Harvested  Acres per Combine"
names(data_economics)[names(data_economics) == "y22_M175_valueNumeric"] <- "Value of Certified or Exempt Organically Produced Commodities Sold, Average per Farm with Organic Sales"


```

## Average Value of Ag Products Sold per Farm
```{r}
census_ag_sales_list <- list(FIPS = data_economics$FIPS, sales = data_economics$`Avg Value of Ag Products Sold per Farm`)
census_ag_sales <- as.data.frame(list(FIPS = data_economics$FIPS, sales = data_economics$`Avg Value of Ag Products Sold per Farm`), row.names=NULL, optional=FALSE)
census_ag_sales$FIPS <- str_pad(census_ag_sales$FIPS, width = 5, side = "left", pad = "0")

```

```{r}
counties_census_ag_sales <- left_join(us_counties_contiguous, census_ag_sales, by = "FIPS")

ggplot(data = counties_census_ag_sales) +
  geom_sf(aes(fill = sales), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(
    fill = "Ag Products Sold",
    title = "Avg Value of Ag Products Sold by County"
  ) +
  theme_minimal()

```

##  Livestock, Poultry, and Products as % of ....
```{r}
## "Value of Livestock, Poultry, and Their Products Sold as Percent of Total Market Value of Agricultural Products Sold"
census_ag_livestock_sales <- as.data.frame(list(FIPS = data_economics$FIPS, livestock_sales = data_economics$`Value of Livestock, Poultry, and Their Products Sold as Percent of Total Market Value of Agricultural Products Sold`), row.names=NULL, optional=FALSE)
census_ag_livestock_sales$FIPS <- str_pad(census_ag_livestock_sales$FIPS, width = 5, side = "left", pad = "0")

```

```{r}
counties_census_ag_livestock_sales <- left_join(us_counties_contiguous, census_ag_livestock_sales, by = "FIPS")

ggplot(data = counties_livestock_sales) +
  geom_sf(aes(fill = livestock_sales), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(fill = "Percentage", title = "Livestock Sales as % of Total Ag Products Sales") +
  theme_minimal()

```


# Census Data

## calculate population density for each county
```{r}
census_api_key("adae1a54296e6933fc3f52229051bc6c99157f53", install = TRUE, overwrite=TRUE)

# total population from ACS 5-year
acs_pop_data <- get_acs(geography = "county",
  variables = "B01003_001",
  year = 2023,
  survey = "acs5")

# us counties
us_counties_area <- us_counties_contiguous %>%
  mutate(land_area_km2 = ALAND / 1e6) %>%  # apparently ALAND is in square meters
  dplyr::select(GEOID, NAME, land_area_km2)

# population density = population / land area
population_density <- acs_pop_data %>%
  rename(GEOID = GEOID, population = estimate) %>%
  left_join(us_counties_area, by = "GEOID") %>%
  mutate(pop_density = population / land_area_km2)

population_density <- st_as_sf(population_density)
population_density <- st_transform(population_density, crs=5070)
population_density <- st_drop_geometry(population_density)
population_density <- subset(population_density, select = -c(NAME.x, NAME.y, land_area_km2, moe, variable))


us_counties_contiguous <- left_join(us_counties_contiguous, population_density, by ="GEOID")
```

## Agriculture employment and wages
```{r}
acs_ag_employment <- get_acs(geography = "county", table = "C24030", year = 2023)
acs_ag_vars <- load_variables(2023, "acs5", cache = TRUE) ## we want C24030_005 (male) and C24030_032 (female)
filter(acs_ag_vars, name == "C24030_005") 
## also C24030_001 is total employment so we can compute percent agriculture employment

## need to add together male and female
ag_wide <- acs_ag_employment %>%
  filter(variable %in% c("C24030_001", "C24030_032", "C24030_005")) %>%
  dplyr::select(GEOID, NAME, variable, estimate) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate, names_prefix = "var_") %>%
  rename(total_employment = var_C24030_001, male_ag_employment = var_C24030_005, female_ag_employment = var_C24030_032) %>%
  mutate(ag_employment = male_ag_employment + female_ag_employment) %>%
  mutate(pct_ag = 100 * ag_employment / total_employment)

ag_wide <- subset(ag_wide, select = -c(NAME))

```
A little confused on why Grundy County, Iowa has the highest proportion of farmland, but 0.13% agriculturally employed... 

## Normalized Agriculture employment and wages
```{r}
ag_data_normalized <- ag_wide %>%
  left_join(acs_pop_data, by = "GEOID") %>%
  mutate(ag_employment_rate = ag_employment / estimate) %>%
  mutate(ag_employment_per_1000 = ag_employment_rate * 1000)

```

## Median Household Income
```{r}
median_income <- get_acs(geography = "tract",
  variables = "B19013_001",
  year = 2023,
  output = "wide",
  state = contiguous_states,
  geometry = TRUE)

median_income <- subset(median_income, select = -c(NAME, B19013_001M))
median_income <- median_income %>% rename(median_income = B19013_001E)
median_income <- st_transform(median_income, st_crs(us_grid))
median_income <- st_drop_geometry(median_income)
us_grid <- left_join(us_grid, median_income, by = "GEOID")

us_grid$median_income[is.na(us_grid$median_income)] <- mean(us_grid$median_income, na.rm=TRUE)


```

# USDA Ag Census Quick Stats (livestock inventory)
```{r}
hogs_data <- read.csv("HogsInventory2022AgCensus.csv")
cattle_data <- read.csv("CattleInventory2022AgCensus.csv")
goats_data <- read.csv("GoatsInventory2022AgCensus.csv")
sheep_data <- read.csv("SheepInventory2022AgCensus.csv")

hogs_data <- subset(hogs_data, select = -c(Program, Period, Week.Ending, Geo.Level, Zip.Code, Region, watershed_code, Watershed, Commodity, Data.Item, Domain, Domain.Category))
cattle_data <- subset(cattle_data, select = -c(Program, Period, Week.Ending, Geo.Level, Zip.Code, Region, watershed_code, Watershed, Commodity, Data.Item, Domain, Domain.Category))
goats_data <- subset(goats_data, select = -c(Program, Period, Week.Ending, Geo.Level, Zip.Code, Region, watershed_code, Watershed, Commodity, Data.Item, Domain, Domain.Category))
sheep_data <- subset(sheep_data, select = -c(Program, Period, Week.Ending, Geo.Level, Zip.Code, Region, watershed_code, Watershed, Commodity, Data.Item, Domain, Domain.Category))

## We have ANSI codes rather than FIPS --> FIPS = State ANSI + County ANSI
hogs_data$State.ANSI  <- sprintf("%02s", hogs_data$State.ANSI)
hogs_data$County.ANSI <- sprintf("%03s", hogs_data$County.ANSI)
hogs_data$FIPS <- paste0(hogs_data$State.ANSI, hogs_data$County.ANSI)
hogs_data <- subset(hogs_data, select = -c(State.ANSI, County.ANSI))

cattle_data$State.ANSI  <- sprintf("%02s", cattle_data$State.ANSI)
cattle_data$County.ANSI <- sprintf("%03s", cattle_data$County.ANSI)
cattle_data$FIPS <- paste0(cattle_data$State.ANSI, cattle_data$County.ANSI)
cattle_data <- subset(cattle_data, select = -c(State.ANSI, County.ANSI))

goats_data$State.ANSI  <- sprintf("%02s", goats_data$State.ANSI)
goats_data$County.ANSI <- sprintf("%03s", goats_data$County.ANSI)
goats_data$FIPS <- paste0(goats_data$State.ANSI, goats_data$County.ANSI)
goats_data <- subset(goats_data, select = -c(State.ANSI, County.ANSI))

sheep_data$State.ANSI  <- sprintf("%02s", sheep_data$State.ANSI)
sheep_data$County.ANSI <- sprintf("%03s", sheep_data$County.ANSI)
sheep_data$FIPS <- paste0(sheep_data$State.ANSI, sheep_data$County.ANSI)
sheep_data <- subset(sheep_data, select = -c(State.ANSI, County.ANSI))


```

## replace (D) with NA
```{r}
library(naniar)
hogs_data <- hogs_data %>% replace_with_na_all(condition = ~.x == " (D)")
hogs_data <- hogs_data %>% replace_with_na_all(condition = ~.x == "(D)")

cattle_data <- cattle_data %>% replace_with_na_all(condition = ~.x == " (D)")
cattle_data <- cattle_data %>% replace_with_na_all(condition = ~.x == "(D)")

goats_data <- goats_data %>% replace_with_na_all(condition = ~.x == " (D)")
goats_data <- goats_data %>% replace_with_na_all(condition = ~.x == "(D)")

sheep_data <- sheep_data %>% replace_with_na_all(condition = ~.x == " (D)")
sheep_data <- sheep_data %>% replace_with_na_all(condition = ~.x == "(D)")

```

## maps of livestock! - hogs
```{r}
library(eeptools)
hogs_list <- list(FIPS = hogs_data$FIPS, num_hogs = hogs_data$Value)
hogs_df <- as.data.frame(hogs_list, row.names=NULL, optional = FALSE)
hogs_df$FIPS <- str_pad(hogs_df$FIPS, width = 5, side = "left", pad = "0")

counties_hogs <- left_join(us_counties_contiguous, hogs_df, by = "FIPS")
counties_hogs$num_hogs <- decomma(counties_hogs$num_hogs)

ggplot(data = counties_hogs) +
  geom_sf(aes(fill = num_hogs), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(
    fill = "Number of Hogs",
    title = "Number of Hogs (Inventory) by County"
  ) +
  theme_minimal()

```


## cattle map
```{r}
library(eeptools)
cattle_list <- list(FIPS = cattle_data$FIPS, num_cattle = cattle_data$Value)
cattle_df <- as.data.frame(cattle_list, row.names=NULL, optional = FALSE)
cattle_df$FIPS <- str_pad(cattle_df$FIPS, width = 5, side = "left", pad = "0")

counties_cattle <- left_join(us_counties_contiguous, cattle_df, by = "FIPS")
counties_cattle$num_cattle <- decomma(counties_cattle$num_cattle)

ggplot(data = counties_cattle) +
  geom_sf(aes(fill = num_cattle), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(
    fill = "Number of Cattle",
    title = "Number of Cattle (Inventory) by County"
  ) +
  theme_minimal()

```

## goats map
```{r}
library(eeptools)
goat_list <- list(FIPS = goats_data$FIPS, num_goats = goats_data$Value)
goat_df <- as.data.frame(goat_list, row.names=NULL, optional = FALSE)
goat_df$FIPS <- str_pad(goat_df$FIPS, width = 5, side = "left", pad = "0")

counties_goat <- left_join(us_counties_contiguous, goat_df, by = "FIPS")
counties_goat$num_goats <- decomma(counties_goat$num_goats)

ggplot(data = counties_goat) +
  geom_sf(aes(fill = num_goats), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(
    fill = "Number of Goats",
    title = "Number of Goats (Inventory) by County"
  ) +
  theme_minimal()

```


## sheep map
```{r}
library(eeptools)
sheep_list <- list(FIPS = sheep_data$FIPS, num_sheep = sheep_data$Value)
sheep_df <- as.data.frame(sheep_list, row.names=NULL, optional = FALSE)
sheep_df$FIPS <- str_pad(sheep_df$FIPS, width = 5, side = "left", pad = "0")

counties_sheep <- left_join(us_counties_contiguous, sheep_df, by = "FIPS")
counties_sheep$num_sheep <- decomma(counties_sheep$num_sheep)

ggplot(data = counties_sheep) +
  geom_sf(aes(fill = num_sheep), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(
    fill = "Number of Sheep",
    title = "Number of Sheep (Inventory) by County"
  ) +
  theme_minimal()

```

## convert to animal units
```{r}
sum(is.na(hogs_data)) ## 1030/2890
sum(is.na(cattle_data)) ## 96/3060
sum(is.na(goats_data)) ## 330/2974
sum(is.na(sheep_data)) ## 558/2908

hogs_data$Value <- decomma(hogs_data$Value)
cattle_data$Value <- decomma(cattle_data$Value)
goats_data$Value <- decomma(goats_data$Value)
sheep_data$Value <- decomma(sheep_data$Value)

hogs_data$hogs_au <- hogs_data$Value * 0.4
cattle_data$cattle_au <- cattle_data$Value * 1
goats_data$goats_au <- goats_data$Value * 0.15
sheep_data$sheep_au <- sheep_data$Value * 0.20

# just keep the two columns we need
goats_data  <- goats_data[, c("FIPS", "goats_au")]
cattle_data <- cattle_data[, c("FIPS", "cattle_au")]
hogs_data <- hogs_data[, c("FIPS", "hogs_au")]
sheep_data <- sheep_data[, c("FIPS", "sheep_au")]

livestock_units <- full_join(cattle_data, hogs_data, by = "FIPS") %>%
  full_join(., goats_data, by = "FIPS") %>%
  full_join(., sheep_data, by = "FIPS")

# replace NAs with 0 and sum
livestock_units <- livestock_units %>%
  mutate(across(c(cattle_au, hogs_au, goats_au, sheep_au), ~replace_na(., 0))) %>%
  mutate(total_livestock_units = cattle_au + hogs_au + goats_au + sheep_au)

counties_livestock_unit <- left_join(us_counties_contiguous, livestock_units, by = "FIPS")


ggplot(data = counties_livestock_unit) +
  geom_sf(aes(fill = total_livestock_units), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(
    fill = "Livestock Units",
    title = "Livestock Units by County"
  ) +
  theme_minimal()
## This graph is of course flawed because of missing data

```

# RUCC USDA ERS data: gives code 1-9 based on rural-urban continuum 
```{r}
rucc <- read_excel("Ruralurbancontinuumcodes2023.xlsx")

# merge with livestock units -->
livestock_units <- livestock_units %>%
  mutate(FIPS = sprintf("%05s", FIPS))

rucc <- rucc %>%
  mutate(FIPS = sprintf("%05s", FIPS))

merged_rucc_livestock <- left_join(livestock_units, rucc, by = "FIPS")

us_grid <- left_join(us_grid, rucc, by = "FIPS")
us_grid <- subset(us_grid, select = -c(Description, State, County_Name))

```


# population density vs livestock units
```{r}
population_density <- rename(population_density, FIPS = GEOID)
population_density <- population_density %>% mutate(FIPS = sprintf("%05s", FIPS))
livestock_units <- livestock_units %>% mutate(FIPS = sprintf("%05s", FIPS))
merged_pop_density_livestock_units <-  left_join(population_density, livestock_units, by = "FIPS")

ggplot(merged_pop_density_livestock_units, aes(x = pop_density, y = total_livestock_units)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Population Density", y = "Livestock Units per County") +
  theme_minimal()

```

# Land Cover data tiff
```{r}
land_cover <- rast("Annual_NLCD_LndCov_2023_CU_C1V0.tif")
plot(land_cover)

# land_cover <- project(land_cover, st_crs(us_counties)$wkt)
## from NLCD Codes: 81 = pasture/hay, 82 = cultivated crops
us_counties_proj <- st_transform(us_counties, crs = crs(land_cover))
# crop raster to counties extent (to reduce memory load)
land_cover_cropped <- crop(land_cover, vect(us_counties_proj))

lc_summary <- exact_extract(land_cover_cropped, us_counties_proj, 'frac', progress = TRUE)
lc_summary <- lc_summary %>%
  rename(pasture_frac = frac_81, crops_frac = frac_82)
lc_summary <- lc_summary %>%
  rename(open_water=frac_11, perennial_ice_snow = frac_12, developed_open = frac_21, developed_low = frac_22, developed_medium = frac_23, developed_high = frac_24, barren = frac_31, deciduous_forest = frac_41, evergreen_forest = frac_42, mixed_forest = frac_43, shrub = frac_52, grassland = frac_71, woody_wetlands = frac_90, herbaceous_wetlands = frac_95)
lc_summary <- cbind(GEOID = us_counties$GEOID, lc_summary)
lc_summary <- lc_summary %>%
  rename(FIPS = GEOID)
model_data <- left_join(livestock_units, lc_summary, by = "FIPS")
model_data$farmland <- model_data$pasture_frac + model_data$crops_frac

```

# NAICS Dataset: Quarterly Census of Employment and Wages Livestock Workers (112)
```{r}
naics <- read.csv("NAICS112.csv")
naics_employment <- as.data.frame(list(FIPS = naics$area_fips, employment = naics$annual_avg_emplvl), row.names=NULL, optional=FALSE)
naics_employment$FIPS <- str_pad(naics_employment$FIPS, width = 5, side = "left", pad = "0")

counties_naics_employment <- left_join(us_counties_contiguous, naics_employment, by = "FIPS")

ggplot(data = counties_naics_employment) +
  geom_sf(aes(fill = employment), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(
    fill = "Employment",
    title = "Average Annual Agriculture Employment by County"
  ) +
  theme_minimal()

```
## Average Annual Pay for Employees
```{r}
naics_employee_wages <- as.data.frame(list(FIPS = naics$area_fips, wages = naics$avg_annual_pay), row.names=NULL, optional=FALSE)
naics_employee_wages$FIPS <- str_pad(naics_employee_wages$FIPS, width = 5, side = "left", pad = "0")

counties_naics_employee_wages <- left_join(us_counties_contiguous, naics_employee_wages, by = "FIPS")

ggplot(data = counties_naics_employee_wages) +
  geom_sf(aes(fill = wages), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(
    fill = "Wages",
    title = "Average Annual Pay for Employees by County"
  ) +
  theme_minimal()

```

## Total Wages
```{r}
naics_total_wages <- as.data.frame(list(FIPS = naics$area_fips, total_wages = naics$total_annual_wages), row.names=NULL, optional=FALSE)
naics_total_wages$FIPS <- str_pad(naics_total_wages$FIPS, width = 5, side = "left", pad = "0")

counties_naics_total_wages <- left_join(us_counties_contiguous, naics_total_wages, by = "FIPS")

ggplot(data = counties_naics_total_wages) +
  geom_sf(aes(fill = total_wages), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(
    fill = "Wages",
    title = "Total Annual Wages by County"
  ) +
  theme_minimal()
```

## Compare Top States by Employment
```{r}
top_states <- counties_naics_employment |>
  group_by(STATE_NAME) |>
  summarize(emp = sum(employment)) |>
  slice_max(emp, n = 10)
top_states$state <- state.abb[match(top_states$STATE_NAME,state.name)]

ggplot(top_states, aes(x = reorder(state, emp), y = emp)) +
  geom_point(alpha=0.6, color="blue") +
  labs(title = "Top 10 States by Livestock Employment") + 
  ylab("Average Annual Employment") +
  scale_y_continuous(labels=scales::dollar_format()) +
  geom_text(label = scales::comma(round(top_states$emp)), label= scales::dollar_format(), nudge_y=500,check_overlap=T, size=3.5) +
  xlab("State") +
  theme_minimal() 
```

## Wages vs Employment
```{r}
naics_employment <- as.data.frame(list(FIPS = naics$area_fips, employment = naics$annual_avg_emplvl, wages=naics$avg_annual_pay), row.names=NULL, optional=FALSE)
naics_employment$FIPS <- str_pad(naics_employment$FIPS, width = 5, side = "left", pad = "0")

counties_naics_employment <- left_join(us_counties_contiguous, naics_employment, by = "FIPS")

ggplot(naics_employment, aes(x = employment, y = wages)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  geom_smooth(method = "lm") +
  labs(title = "Wages vs. Employment in Animal Production",
       x = "Total Employment", y = "Average Weekly Wage") +
  theme_minimal()

```

## Wages vs Employment in Top 10 Employment States
```{r}
top_states <- counties_naics_employment |>
  group_by(STATE_NAME) |>
  summarize(emp = mean(employment), wages = mean(wages)) |>
  slice_max(emp, n = 10)
top_states$state <- state.abb[match(top_states$STATE_NAME,state.name)]


ggplot(top_states, aes(x = emp, y = wages)) +
  geom_point(color="black") +
  labs(title = "Top 10 States by Livestock Employment") + 
  ylab("Average Annual Pay") +
  xlab("Average Annual Employment") +
  geom_smooth(method='lm', formula= y~x, color="red") +
  geom_text(label = top_states$state, nudge_y=1000, size=2.5) +
  theme_minimal() 

```

## Compare Top States by Livestock Wages
```{r}
top_states_wages <- counties_naics_employment |>
  group_by(STATE_NAME) |>
  summarize(wages = mean(wages)) |>
  slice_max(wages, n = 10)
top_states_wages$state <- state.abb[match(top_states_wages$STATE_NAME,state.name)]

ggplot(top_states_wages, aes(x = reorder(state, wages), y = wages)) +
  geom_point(alpha=0.6, color="blue") +
  labs(title = "Top 10 States by Average Annual Pay for Livestock Workers") + 
  ylab("Average Annual Pay") +
  xlab("State") +
  scale_y_continuous(labels=scales::dollar_format()) +
  geom_text(label = scales::dollar(round(top_states_wages$wages)), label= scales::dollar_format(), nudge_y=1200,check_overlap=T, size=3.5) +
  theme_minimal() 
```

# Scatterplot Ag Products Sold and Pop Density
```{r}
census_ag_sales <- census_ag_sales %>% mutate(FIPS = sprintf("%05s", FIPS))
merged_pop_density_agsales <-  left_join(population_density, census_ag_sales, by = "FIPS")

ggplot(merged_pop_density_agsales, aes(x = pop_density, y = sales)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Population Density", y = "Agricultral Products Sold by County") +
  theme_minimal()
```

# Scatterplot Ag Products Sold and Farm Density (NLCD)
```{r}
merged_nlcd_agsales <- left_join(model_data, ag_sales, by="FIPS")

ggplot(merged_nlcd_agsales, aes(x = farmland, y = sales)) +
  geom_point() +
  scale_y_log10() +
  geom_smooth(method='lm', formula= y~x, color="red") +
  labs(x = "% Farmland", y = "Agricultral Products Sold by County") +
  theme_minimal()

```


# Air Pollution
## CO
```{r}
co_pollutant <- read.csv("CO_pollutant.csv")
co_pollutant <- st_as_sf(co_pollutant, coords = c("Longitude", "Latitude"), crs = 4326)
co_pollutant <- subset(co_pollutant, select = -c(Datum, Units.of.Measure))
co_pollutant$State.Code <- as.character(co_pollutant$State.Code)
co_pollutant$County.Code <- as.character(co_pollutant$County.Code)
co_pollutant$State.Code  <- sprintf("%02s", co_pollutant$State.Code)
co_pollutant$County.Code <- sprintf("%03s", co_pollutant$County.Code)
co_pollutant$FIPS <- paste0(co_pollutant$State.Code, co_pollutant$County.Code)

co_8hr_pollutant <- co_pollutant %>% filter(Sample.Duration == "8-HR RUN AVG END HOUR")
co_8hr_pollutant <- subset(co_8hr_pollutant, select = -c(Parameter.Name, Sample.Duration, Pollutant.Standard))

co_8hr_pollutant <- st_as_sf(co_8hr_pollutant, coords = c("Longitude", "Latitude"), crs = 4326)

```

### IDW
```{r}
co_8hr_pollutant <- st_transform(co_8hr_pollutant, st_crs(minnesota_grid_sf))

CO_minnesota_sp <- as(co_8hr_pollutant, "Spatial")
mn_grid_sp <- as(minnesota_grid_sf, "Spatial")

idw_CO_minnesota <- idw(Arithmetic.Mean ~ 1, locations = CO_minnesota_sp, newdata = mn_grid_sp, idp = 2.5, nmax = 50)
idw_CO_minnesota_sf <- st_as_sf(idw_CO_minnesota)


minnesota_grid_sf$pred_CO <- idw_CO_minnesota_sf$var1.pred

ggplot() +
  geom_sf(data = minnesota_grid_sf, aes(fill = pred_CO), color = NA) +
  scale_fill_viridis_c(option = "plasma", name = "Predicted CO") +
  theme_minimal() +
  labs(title = "IDW Interpolation of CO in MN",
       fill = "CO (ppm)")


```


## Toxic Releases to Air - EJScreen (EPA)
```{r}
toxic_releases <- read.csv("mn_toxic_releases.csv")
toxic_releases <- st_as_sf(toxic_releases, coords = c("Longitude", "Latitude"),crs = 4326)
toxic_releases <- st_transform(toxic_releases, 5070)
toxic_releases <- toxic_releases %>% rename(`releases` = `Releases..lb.`)
toxic_releases$releases <- decomma(toxic_releases$releases)

toxic_releases$releases <- as.numeric(toxic_releases$releases)
summary(toxic_releases$releases)
hist(toxic_releases$releases)

toxic_releases$releases[is.na(toxic_releases$releases)] <- 0

minnesota_counties |> 
  st_union() -> MN
ggplot() +
  geom_sf(
    data = MN,
    fill = "white",
    color = "black"
    ) +
  geom_sf(
    data = toxic_releases,
    aes(color = releases))

minnesota_grid <- MN  |> 
  st_bbox() |>  
  st_make_grid(cellsize = 10000)   

ggplot() +
  geom_sf(
    data = MN,
    fill = "white",
    color = "black"
  ) +
  geom_sf(
    data = toxic_releases,
    aes(color = releases)
  ) +
  geom_sf(
    data = minnesota_grid,
    fill = NA
  ) 


```

### IDW
```{r}
library(gstat)
idw(formula = releases ~ 1, locations = toxic_releases, newdata = minnesota_grid, idp = 2.0) -> idw_output2
summary(idw_output2$var1.pred)
hist(idw_output2$var1.pred)
library(classInt)
nbreaks <- classIntervals(idw_output2$var1.pred, n = 5, style = "jenks")$brks

ggplot() +
  geom_sf(
    data = MN,
    fill = "white",
    color = "black"
  ) +
  geom_sf(
    data = idw_output2,
    aes(fill = var1.pred),
    color = NA,
    alpha = .9
  ) +
  scale_fill_fermenter(
    direction = 1,
    palette = "YlOrRd",
    breaks = nbreaks
  )

idw_output |> 
  st_intersection(MN) -> idw_output


minnesota_grid <- st_join(minnesota_grid, idw_output2, left = TRUE,largest = TRUE)
minnesota_grid <- subset(minnesota_grid, select = -c(x, y, var1.var))

ggplot() +
  geom_sf(
    data = MN,
    fill = "white",
    color = "black"
  ) +
  geom_sf(
    data = idw_output,
    aes(fill = var1.pred),
    color = NA,
    alpha = .9
  ) +
  scale_fill_fermenter(
    direction = 1,
    palette = "YlOrRd",
    breaks = nbreaks
 )


```
### IDW using regular grid
```{r}
toxic_releases <- read.csv("mn_toxic_releases.csv")
toxic_releases <- st_as_sf(toxic_releases, coords = c("Longitude", "Latitude"),crs = 4326)
toxic_releases <- st_transform(toxic_releases, st_crs(minnesota_grid))
toxic_releases <- toxic_releases %>% rename(`releases` = `Releases..lb.`)
toxic_releases$releases <- decomma(toxic_releases$releases)

toxic_releases$releases <- as.numeric(toxic_releases$releases)
summary(toxic_releases$releases)
hist(toxic_releases$releases)

toxic_releases$releases[is.na(toxic_releases$releases)] <- 0
idw(formula = releases ~ 1, locations = toxic_releases, newdata = minnesota_grid, idp = 2.0) -> idw_output
summary(idw_output$var1.pred)
hist(idw_output$var1.pred)

nbreaks <- classIntervals(idw_output$var1.pred, n = 5, style = "jenks")$brks

ggplot() +
  geom_sf(
    data = minnesota_grid,
    fill = "white",
    color = "black"
  ) +
  geom_sf(
    data = idw_output,
    aes(fill = var1.pred),
    color = NA,
    alpha = .9
  ) +
  scale_fill_fermenter(
    direction = 1,
    palette = "YlOrRd",
    breaks = nbreaks
  )


minnesota_grid <- st_join(minnesota_grid, idw_output)
minnesota_grid <- subset(minnesota_grid, select = -c(x, y, var1.var))

county_tri <- minnesota_grid %>%
  group_by(FIPS) %>%
  summarise(mean_tri = mean(var1.pred, na.rm=TRUE))
county_tri <- st_drop_geometry(county_tri)

minnesota_counties <- left_join(minnesota_counties, county_tri, by="FIPS")

```


## Methane
```{r}
library("ncdf4")
methane <- nc_open("Gridded_GHGI_Methane_v2_2018.nc")
print(methane)

methane <- raster("Gridded_GHGI_Methane_v2_2018.nc", varname = "emi_ch4_1A_Combustion_Mobile")
 
# Quick plot
plot(methane)
methane_df <- as.data.frame(methane, xy = TRUE, na.rm = TRUE)
methane_df <- methane_df %>% rename(`1A` = X2018.Methane.emissions.from.IPCC.source.category.1A.Combustion.Mobile)


ggplot(methane_df, aes(x = x, y = y, fill = `1A`)) +
  geom_raster() +
  scale_fill_viridis_c() +
  coord_fixed() +
  theme_minimal()


methane <- exact_extract(methane, us_grid, 'mean')
methane_df <- as.data.frame(methane, xy = TRUE, na.rm = TRUE)
us_grid$methane <- methane_df$methane

ggplot(cont_grid_sf) +
  geom_sf(aes(fill = methane), color=NA) +
  scale_fill_viridis_c(option = "C") +
  theme_minimal() +
  labs(title = "Methane Distribution in the U.S.",
       fill = "Methane")

```

# Compiled CAFO Data
```{r}
cafo_compiled <- st_read("cafo_state_subset_with_coords/cafo_state_subset.shp")
cafo_compiled <- st_transform(cafo_compiled, crs = 5070)

ggplot() +
  geom_sf(data = us_counties_contiguous, fill = "lightblue", color = "black", size = 0.2) + 
  geom_sf(data = cafo_compiled, aes(color = "CAFOs"), size = 0.001) + 
  scale_color_manual(values = c("CAFOs" = "red")) +
  labs(title = "CAFO Locations in Contiguous US",
       color = "Legend") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

```


## Interactive CAFO Map with Outbreaks
```{r}
us_counties_contiguous <- st_transform(us_counties_contiguous, crs = st_crs(cafo_compiled))

leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>% # Add a basemap
  addPolygons(data = us_counties_contiguous, 
              color = "black", 
              weight = 1, 
              fill = FALSE, 
              group = "U.S. Counties") %>%
  addCircleMarkers(data = outbreaks_sf,
                   radius = 4,
                   color = "red",
                   popup = ~paste(
                     "<b>Outbreak Details:</b><br>",
                     paste0("Latitude: ", st_coordinates(geometry)[, 2], "<br>"),
                     paste0("Longitude: ", st_coordinates(geometry)[, 1], "<br>"),
                     ifelse(!is.na(date_confirmed), paste0("date_confirmed: ", date_confirmed, "<br>"), ""),
                     ifelse(!is.na(production_type), paste0("production_type: ", production_type, "<br>"), "")
                   ),
                   group = "Outbreaks") %>%
  addCircleMarkers(data = cafo_compiled,
                   radius = 1,
                   color = "blue",
                   popup = ~paste(
                     "<b>CAFO Details:</b><br>",
                     paste0("Latitude: ", st_coordinates(geometry)[, 2], "<br>"),
                     paste0("Longitude: ", st_coordinates(geometry)[, 1], "<br>"),
                     ifelse(!is.na(facility_n), paste0("CAFO Name: ", facility_n, "<br>"), "")
                   ),
                   group = "CAFOs") %>%
  addLayersControl(overlayGroups = c("U.S. Counties", "CAFOs", "Outbreaks"),
                   options = layersControlOptions(collapsed = FALSE))


```


# Compiling CAFOs

## Louisiana Clean-up
```{r}
la_cafos <- read.csv("CAFOs to be compiled/CAFOs in Louisiana.csv")
la_cafos <- subset(la_cafos, select = -c(ANIMAL_CNT, E_ANIMAL_C, AU, E_AU, MANURE_AMT, E_MANURE_A, T_MANURE_A, NOTE, NAME, CAFO_SUBTY))
la_cafos <- la_cafos %>% rename(address=ADDRESS, state=STATE, zip=ZIP, facility_t = CAFO_TYPE)

la_cafos <- st_as_sf(la_cafos, coords = c("LONG", "LAT"), crs = 4326)
la_cafos <- subset(la_cafos, select = -c(x,y))

la_cafos$state_name <- state.name[match(la_cafos$state, state.abb)] 
st_crs(us_counties_contiguous) == st_crs(la_cafos)
la_cafos <- st_transform(la_cafos, st_crs(us_counties_contiguous))

la_cafos <- st_join(la_cafos, us_counties_contiguous %>% select(NAMELSAD, GEOID))

la_cafos <- la_cafos %>%
  rename(county = NAMELSAD, fips = GEOID)

```

## New York Clean-up
```{r}
ny_cafos <- st_read("CAFOs to be compiled/CAFOs in New York/CAFOs in New York.shp")
ny_cafos <- st_transform(ny_cafos, crs=4326)

ny_cafos <- subset(ny_cafos, select = -c(OBJECTID, SPDES_ID, MOREINFO, FACILITY_S))

ny_cafos <- ny_cafos %>% rename(facility_n = FACILITY_N)
ny_cafos$state <- "NY"
ny_cafos$state_name <- state.name[match(ny_cafos$state, state.abb)] 
st_crs(us_counties_contiguous) == st_crs(ny_cafos)
ny_cafos <- st_transform(ny_cafos, st_crs(us_counties_contiguous))

ny_cafos <- st_join(ny_cafos, us_counties_contiguous %>% select(NAMELSAD, GEOID))

ny_cafos <- ny_cafos %>%
  rename(county = NAMELSAD, fips = GEOID)

```

## Alabama Clean-up
```{r}
al_cafos <- read.csv("CAFOs to be compiled/CAFOs in Alabama.csv")
al_cafos <- subset(al_cafos, select = -c(ANIMAL_CNT, E_ANIMAL_C, E_AU, MANURE_AMT))
al_cafos <- al_cafos %>% rename(facility_n = NAME, address=ADDRESS, state=STATE, zip=ZIP, facility_t = CAFO_TYPE, animal_uni = AU, e_manure_a = E_MANURE_A, t_manure_a = T_MANURE_A)

al_cafos <- st_as_sf(al_cafos, coords = c("LONG", "LAT"), crs=4326)
al_cafos <- subset(al_cafos, select = -c(x,y))

al_cafos$state_name <- state.name[match(al_cafos$state, state.abb)] 
st_crs(us_counties_contiguous) == st_crs(al_cafos)
al_cafos <- st_transform(al_cafos, st_crs(us_counties_contiguous))

al_cafos$animal_uni <- decomma(al_cafos$animal_uni)

al_cafos <- st_join(al_cafos, us_counties_contiguous %>% select(NAMELSAD, GEOID))

al_cafos <- al_cafos %>%
  rename(county = NAMELSAD, fips = GEOID)

```


## Arkansas Clean-up
```{r}
ar_cafos <- read.csv("CAFOs to be compiled/CAFOs in Arkansas.csv")

ar_cafos <- ar_cafos %>% rename(facility_n = NAME, address=ADDRESS, state=STATE, zip=ZIP, facility_t = CAFO_TYPE)
ar_cafos <- st_as_sf(ar_cafos, coords = c("LONG", "LAT"), crs=4326)
ar_cafos <- subset(ar_cafos, select = -c(x,y))

ar_cafos$state_name <- state.name[match(ar_cafos$state, state.abb)] 
st_crs(us_counties_contiguous) == st_crs(ar_cafos)
ar_cafos <- st_transform(ar_cafos, st_crs(us_counties_contiguous))
ar_cafos$zip <-as.numeric(ar_cafos$zip)
ar_cafos <- st_join(ar_cafos, us_counties_contiguous %>% select(NAMELSAD, GEOID))

ar_cafos <- ar_cafos %>%
  rename(county = NAMELSAD, fips = GEOID)

ar_cafos <- subset(ar_cafos, select = -c(CAFO_SUBTY))

```


## Colorado Clean-up
```{r}
co_cafos <- st_read("CAFOs to be compiled/CAFOS in Colorado/CAFOS in Colorado.shp")
co_cafos <- subset(co_cafos, select = -c(Data_Sourc, Permitted_, DATE_Geoco, RECORD_ID, TYPE, CITY, ADDRESS, Out_County))

co_cafos <- co_cafos %>% rename(facility_t = PRIMARY_LI, zip=ZIP,state=STATE, address=ADDRESS_FU, county=COUNTY, facility_n = RECORD_NAM)
co_cafos <- st_transform(co_cafos, crs=4326)

co_cafos$state_name <- state.name[match(co_cafos$state, state.abb)] 
st_crs(us_counties_contiguous) == st_crs(co_cafos)
co_cafos <- st_transform(co_cafos, st_crs(us_counties_contiguous))
co_cafos$zip <-as.numeric(co_cafos$zip)

co_cafos <- st_join(co_cafos, us_counties %>% select(GEOID))

co_cafos <- co_cafos %>%
  rename(fips = GEOID)

```

## Florida Clean-up
```{r}
fl_cafos <- read.csv("CAFOs to be compiled/CAFOs in Florida.csv")
fl_cafos <- subset(fl_cafos, select = -c(E_ANIMAL_C, AU, E_AU, E_MANURE_A, NOTE))
fl_cafos <- fl_cafos %>% rename(zip=ZIP, state=STATE, address=ADDRESS, facility_n = NAME, facility_t=CAFO_TYPE, animal_cou = ANIMAL_CNT, t_manure_a = T_MANURE_A, manure_amt = MANURE_AMT)
fl_cafos <- st_as_sf(fl_cafos, coords = c("LONG", "LAT"), crs=4326)
fl_cafos <- subset(fl_cafos, select= -c(x,y))

fl_cafos$state_name <- state.name[match(fl_cafos$state, state.abb)] 
st_crs(us_counties_contiguous) == st_crs(fl_cafos)
fl_cafos <- st_transform(fl_cafos, st_crs(us_counties_contiguous))

fl_cafos <- st_join(fl_cafos, us_counties %>% select(NAMELSAD, GEOID))

fl_cafos <- fl_cafos %>%
  rename(county = NAMELSAD, fips = GEOID)


```


## Georgia Clean-up
```{r}
ga_cafos <- read.csv("CAFOs to be compiled/CAFOs in Georgia.csv")
ga_cafos <- subset(ga_cafos, select = -c(E_AU, E_MANURE_A, MANURE_AMT, T_MANURE_A, NOTE))
ga_cafos <- ga_cafos %>% rename(zip=ZIP, state=STATE, address=ADDRESS, facility_n = NAME, facility_t=CAFO_TYPE)
ga_cafos <- st_as_sf(ga_cafos, coords = c("LONG", "LAT"), crs=4326)
ga_cafos <- subset(ga_cafos, select = -c(x,y))

ga_cafos$state_name <- state.name[match(ga_cafos$state, state.abb)] 
st_crs(us_counties_contiguous) == st_crs(ga_cafos)
ga_cafos <- st_transform(ga_cafos, st_crs(us_counties_contiguous))

ga_cafos <- st_join(ga_cafos, us_counties %>% select(NAMELSAD, GEOID))

ga_cafos <- ga_cafos %>%
  rename(county = NAMELSAD, fips = GEOID)
```
## Texas Clean-up
```{r}
tx_cafos <- read.csv("CAFOs to be compiled/CAFOs in Texas.csv")
tx_cafos <- subset(tx_cafos, select = -c(CAFO_SUBTY, E_AU, E_MANURE_A, MANURE_AMT, T_MANURE_A, NOTE, ANIMAL_CNT, E_ANIMAL_C, AU))
tx_cafos <- tx_cafos %>% rename(zip=ZIP, state=STATE, address=ADDRESS, facility_n=NAME, facility_t=CAFO_TYPE)
tx_cafos <- st_as_sf(tx_cafos, coords = c("LONG", "LAT"), crs=4326)
tx_cafos <- subset(tx_cafos, select = -c(x,y))

tx_cafos$state_name <- state.name[match(tx_cafos$state, state.abb)] 
st_crs(us_counties_contiguous) == st_crs(tx_cafos)
tx_cafos <- st_transform(tx_cafos, st_crs(us_counties_contiguous))

```

## Mississippi Clean-up
```{r}
ms_cafos <- read.csv("CAFOs to be compiled/CAFOs in Mississippi.csv")
ms_cafos <- subset(ms_cafos, select = -c(CAFO_SUBTY, E_AU, E_MANURE_A, MANURE_AMT, T_MANURE_A, NOTE, ANIMAL_CNT, E_ANIMAL_C, AU))
ms_cafos <- ms_cafos %>% rename(zip=ZIP, state=STATE, address=ADDRESS, facility_n=NAME, facility_t=CAFO_TYPE)
ms_cafos <- st_as_sf(ms_cafos, coords = c("LONG", "LAT"), crs=4326)
ms_cafos <- subset(ms_cafos, select = -c(x,y))

ms_cafos$state_name <- state.name[match(ms_cafos$state, state.abb)] 
st_crs(us_counties_contiguous) == st_crs(ms_cafos)
ms_cafos <- st_transform(ms_cafos, st_crs(us_counties_contiguous))

ms_cafos <- st_join(ms_cafos, us_counties %>% select(NAMELSAD, GEOID))

ms_cafos <- ms_cafos %>%
  rename(county = NAMELSAD, fips = GEOID)

```


## Wisconsin Clean-up
```{r}
wi_cafos <- read_excel("CAFOs to be compiled/CAFOs in Wisconsin.xlsx")
wi_cafos <- subset(wi_cafos, select= -c(`Permit #`, `Permit Reissuance #`, `Permit Mod #`, `FIN (Facility ID)`, `Region`, `Permit Status`, `Issued Date`, `EffectiveDate`, `Expiration Date`, `Animal Unit Date`, `Range`, `Proposed Date`, `Township`, `Section`, `Q`, `QQ`))
wi_cafos <- wi_cafos %>% rename(facility_n = `Permittee Name`, county=County, address=Address, animal_typ = `Animal Type`, animal_uni = `Animal Units`)
wi_addresses <- as.data.frame(wi_cafos$address)
write.csv(wi_addresses, "wi_address.csv", row.names=FALSE)
wi_addresses <- read.csv("address_wi.csv")
wi_addresses <- wi_addresses %>% rename(address = wi_cafos_address)

wi_cafos <- wi_cafos[order(wi_cafos$address), ]
wi_addresses <- wi_addresses[order(wi_addresses$address), ]
wi_cafos <- left_join(wi_cafos, wi_addresses, by = "address", relationship="many-to-many")

wi_cafos <- st_as_sf(wi_cafos, coords=c("Long", "Lat"), crs=4326)

wi_cafos$state <- "WI"
wi_cafos$state_name <- state.name[match(wi_cafos$state, state.abb)] 
st_crs(us_counties_contiguous) == st_crs(wi_cafos)
wi_cafos <- st_transform(wi_cafos, st_crs(us_counties_contiguous))

wi_cafos <- st_join(wi_cafos, us_counties_contiguous %>% dplyr::select(GEOID))
wi_cafos <- wi_cafos %>%
  rename(fips = GEOID)

```


## Minnesota CAFOs
```{r}
mn_cafos <- read.csv("MN_CAFOs.csv")
mn_cafos <- st_as_sf(mn_cafos, coords = c("Long", "Lat"), crs = 4326)
names(mn_cafos)

mn_cafos <- subset(mn_cafos, select= -c(feedlot_id, cnty_id, confidence, contphone, active, cafo, open_lot, other, contname))
mn_cafos <- mn_cafos %>% rename(facility_n = name, animal_typ = primstock, animal_uni = totalau, animal_cou = totalan)
mn_cafos$state_name <- "Minnesota"
mn_cafos$state <- "MN"


ggplot() +
  geom_sf(data = minnesota_counties, fill = "lightblue", color = "black", size = 0.2) + 
    geom_sf(data = mn_cafos, aes(color = "Feedlots"), size = 0.5) +
  geom_sf(data = mn_outbreaks, aes(color = "Outbreaks"), size = 1) +                    
  scale_color_manual(values = c("Outbreaks" = "red", "Feedlots" = "blue")) +            
  labs(title = "HPAI Outbreaks and CAFOs in Minnesota",
       color = "Legend") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) # Centered title

```

## Nebraska CAFOs
```{r}
ne_cafos <- st_read("illinois_nebraska_cafo/Nebraska_CAFO.shp")
names(ne_cafos)
ne_cafos <- subset(ne_cafos, select = -c(Permit, Applicatio, Facility_I))
ne_cafos <- ne_cafos %>% rename(facility_n = Facility_N, state_name = State, county = County, address=Address, city=City)
ne_cafos$state <- "NE"
library(usmap)
library(fipio)
ne_cafos$state_fips <- fips(state = "Nebraska")
ne_cafos$fips <- as_fips(state = "Nebraska", county = ne_cafos$county)
ne_cafos <- subset(ne_cafos, select = -c(state_fips))
ne_cafos <- st_transform(ne_cafos, crs =5070)

```

## Illinois CAFOs
```{r}
il_cafos <- st_read("illinois_nebraska_cafo/Illinois_CAFO.shp")
names(il_cafos)
il_cafos <- subset(il_cafos, select = -c(Date_Recei, Nearest_To, Status, Project_Ty, Owner_Phon, Facility_P, Quarter_Qu, Quarter_Se, Section, Township, Range, Principle_, CAFO_ID, SymbolID, Facilty_Zi, Project_An))
il_cafos <- il_cafos %>% rename(county = County, facility_t=Species, facility_n = Facility_N, address = Facility_A,city = Facility_C, state = strFacilit, animal_uni = Total_Site)
il_cafos$county[il_cafos$county == "Vermillion"] <- "Vermilion"
il_cafos$fips <- as_fips(state = "Illinois", county = il_cafos$county)
il_cafos$state_name <- "Illinois"

il_cafos <- st_transform(il_cafos, crs =5070)


```

## Missouri CAFOs
```{r}
mo_cafos <- st_read("MO_NPDES_Animal_Feeding_Operations/MO_NPDES_Animal_Feeding_Operations.shp")
mo_cafos <- subset(mo_cafos, select = c(FAC_CITY, FAC_ADD1, FAC_NAME, FAC_COUNTY, BEEF, DAIRY, BROILERS, LAYERS, PULLETS, TURKEYS, SW_OVR_55, SW_UND_55, GOAT, HORSE, PF_TOTALAU, geometry))
mo_cafos <- subset(mo_cafos, select = -c(LAYERS))
mo_cafos <- mo_cafos %>% rename(county = FAC_COUNTY, facility_n = FAC_NAME, address = FAC_ADD1, city = FAC_CITY, animal_uni = PF_TOTALAU, goat_cou = GOAT, small_swin = SW_UND_55, large_swin = SW_OVR_55, horse_cou = HORSE, pullet_cou = PULLETS, turkey_cou = TURKEYS, chicken_co = BROILERS, dairy_coun = DAIRY, beef_cou = BEEF)
mo_cafos$state_name <- "Missouri"
mo_cafos$state <- "MO"
mo_cafos$fips <- as_fips(state = "Missouri", county = mo_cafos$county)
mo_cafos <- st_transform(mo_cafos, crs = 5070)

```
## Washington CAFOs
```{r}
wa_cafos <- st_read("CAFOs to be compiled/WA_Dairies_2019_OCIO_-7324419961240643796/WADairies.shp")
wa_cafos <- subset(wa_cafos, select = -c(AG_ID, Reg, CAFO_Statu, CAFO_ID, R_Current_, R_Current1, R_Curren_1, R_Curren_2, R_Curren_3, Lat, Long, WRIA, Cons_Distr, GlobalID, DNMA_Statu))
wa_cafos <- wa_cafos %>% rename(facility_s = Facility_S, facility_n = Business_N, address = S_Address, city = S_City, county = County)
wa_cafos$state_name <- "Washington"
wa_cafos$state <- "WA"
wa_cafos$fips <- as_fips(state = "Washington", county = wa_cafos$county)
wa_cafos <- st_transform(wa_cafos, crs = 5070)


```

## California CAFOs
```{r}
ca_cafos <- st_read("CAFOS to be compiled/CAFO_California/animal_type.shp")
names(ca_cafos)
ca_cafos <- subset(ca_cafos, select = -c(WDID, CAFO_Subty, Latitude, Longitude))
ca_cafos <- ca_cafos %>% rename(facility_t = CAFO_Type, animal_cou = CAFO_Popul, city = Place_City, state = Place_Stat, zip = Place_Zip, manure_prod = Manure_per)
ca_cafos$state_name = "California"
ca_cafos$fips <- as_fips(state = "California", county = ca_cafos$county)
ca_cafos <- st_transform(ca_cafos, crs = 5070)

ca_cafos <- read.csv("facilities.csv")
names(ca_cafos)
ca_cafos <- subset(ca_cafos, select = -c(facility_id, lat_min, lon_min, lat_max, lon_max, construction_upper, construction_lower, destruction_lower, destruction_upper, footprint_sq_m, census_tract, census_blockgroup))
ca_cafos <- st_as_sf(ca_cafos, coords = c("longitude", "latitude"), crs = 4326)


ggplot() +
  geom_sf(data = us_counties_contiguous, fill = "lightblue", color = "black", size = 0.2) + 
  geom_sf(data = ca_cafos, aes(color = "CAFOs")) + 
  scale_color_manual(values = c("CAFOs" = "black")) +
  labs(title = "CAFO Locations in CA", color = "", family = "Helvetica") +
  guides(color = guide_legend(override.aes = list(size = 2, alpha = 1))) + 
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5, family = "Helvetica"))



```


## New York Distance Stats
```{r}
ny_outbreaks <- outbreaks_sf %>%
  filter(state == "NY") 
st_crs(ny_outbreaks)
ny_outbreaks <- st_transform(ny_outbreaks, st_crs(ny_cafos))
dist_matrix <- st_distance(ny_outbreaks, ny_cafos)

# Find the minimum distance and the corresponding feedlot for each outbreak
closest_feedlot <- apply(dist_matrix, 1, function(row) {
  min_dist <- min(row)
  closest_idx <- which.min(row)
  list(distance = min_dist, feedlot_idx = closest_idx)
})

# Add the closest feedlot details to the outbreaks data
ny_outbreaks$closest_feedlot_distance <- sapply(closest_feedlot, function(x) as.numeric(x$distance))
ny_outbreaks$closest_feedlot_id <- sapply(closest_feedlot, function(x) x$feedlot_idx)

# Add feedlot geometry for mapping
ny_outbreaks$closest_feedlot_geom <- st_geometry(ny_cafos[ny_outbreaks$closest_feedlot_id, ])


min_distance <- min(ny_outbreaks$closest_feedlot_distance)
max_distance <- max(ny_outbreaks$closest_feedlot_distance)
avg_distance <- mean(ny_outbreaks$closest_feedlot_distance)
median_distance <- median(ny_outbreaks$closest_feedlot_distance)

# Print the statistics
cat("Minimum Distance:", min_distance, "meters\n")
cat("Maximum Distance:", max_distance, "meters\n")
cat("Average Distance:", avg_distance, "meters\n")
cat("Median Distance:", median_distance, "meters\n")


```


## Assess clustering of cafos

```{r, cafo clustering}
library(spatstat)
# Convert sf objects to spatial points
ny_outbreaks_ppp <- as.ppp(st_coordinates(ny_outbreaks), W = owin(range(st_bbox(ny_outbreaks)[c(1,3)]), 
                                                             range(st_bbox(ny_outbreaks)[c(2,4)])))

ny_cafos_ppp <- as.ppp(st_coordinates(ny_cafos), W = owin(range(st_bbox(ny_cafos)[c(1,3)]), 
                                                     range(st_bbox(ny_cafos)[c(2,4)])))

# Compute nearest neighbor distances
nn_ny_cafos <- nndist(ny_cafos_ppp)
nn_random <- runif(length(nn_ny_cafos), min(nn_ny_cafos), max(nn_ny_cafos))  # Simulated random pattern

# Compare mean distances
mean(nn_ny_cafos) < mean(nn_random)  # If true, cleaned_feedlots_sf are more clustered than expected
# TRUE --> ny_cafos more clustered than expected

# Visualizing
plot(ny_cafos_ppp, main = "CAFO Locations")
plot(ny_outbreaks_ppp, add = TRUE, col = "red")

```




## NY Moran's I
```{r}
library(spdep)
# Convert CAFOs and Outbreaks to spatial points
ny_cafo_coords <- st_coordinates(ny_cafos)
ny_outbreak_coords <- st_coordinates(ny_outbreaks)

# Create k-nearest neighbors spatial weight matrices (e.g., k=4)
ny_cafo_knn <- knearneigh(ny_cafo_coords, k = 4)
ny_cafo_nb <- knn2nb(ny_cafo_knn)
ny_cafo_weights <- nb2listw(ny_cafo_nb, style = "W")

ny_outbreak_knn <- knearneigh(ny_outbreak_coords, k = 4)
ny_outbreak_nb <- knn2nb(ny_outbreak_knn)
ny_outbreak_weights <- nb2listw(ny_outbreak_nb, style = "W")

# Compute Moran's I for CAFO locations (using x-coordinates as proxy for density)
ny_moran_cafo <- moran.test(ny_cafo_coords[,1], ny_cafo_weights)

print(ny_moran_cafo)

# Compute Moran's I for Outbreak locations (using x-coordinates as proxy)
ny_moran_outbreak <- moran.test(ny_outbreak_coords[,1], ny_outbreak_weights)

print(ny_moran_outbreak)


```

# CAFO Density EPA
```{r, fig.align="center", echo = FALSE, fig.width = 14}
epa_cafo_density <- st_read("CAFO_Density/CAFOs_per_County.shp")
epa_cafo_density <- as.data.frame(list(FIPS = epa_cafo_density$FIPS, number = epa_cafo_density$CAFOs), row.names=NULL, optional=FALSE)
epa_cafo_density$FIPS <- str_pad(epa_cafo_density$FIPS, width = 5, side = "left", pad = "0")
us_counties_contiguous$FIPS <- us_counties_contiguous$GEOID
counties_cafo_density <- left_join(us_counties_contiguous, epa_cafo_density, by = "FIPS")

ggplot(data = counties_cafo_density) +
  geom_sf(aes(fill = number), color = "black", lwd=0.2) +
  scale_fill_viridis_c(option = "plasma", na.value = "gray90") +
  labs(fill = "CAFOs", title = "CAFOs in the U.S.") +
  theme_minimal()

```
